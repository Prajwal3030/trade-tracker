rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Trades collection - users can only read/write their own trades
    match /trades/{tradeId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
    }

    // User credentials collection
    match /userCredentials/{userId} {
      // Users can read their own credentials
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Users can create their own credentials document
      allow create: if request.auth != null && 
        request.auth.uid == userId &&
        request.resource.data.userId == userId;
      
      // Users can update their own credentials
      allow update: if request.auth != null && 
        request.auth.uid == userId &&
        request.resource.data.userId == userId;
      
      // Users can delete their own credentials
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow queries on userCredentials collection
    // This is needed for:
    // 1. Username availability checking (authenticated users)
    // 2. Username lookup for login (unauthenticated users - only username field)
    match /userCredentials/{document=**} {
      // Allow read for authenticated users
      allow read: if request.auth != null;
      
      // Allow unauthenticated queries but only return username and email (for login)
      // Note: Firestore rules can't filter fields, but we allow the query
      // The client should only use username and email from the result
      allow list: if true; // Allow queries for login purposes
    }

    // Strategies collection - users can only read/write their own strategies
    match /strategies/{strategyId} {
      // Allow reading individual documents if user owns them
      allow get: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
      
      // Allow listing/querying strategies - Firestore will filter by where clause
      // The where("userId", "==", userId) in the query ensures users only see their own
      allow list: if request.auth != null;
      
      // Allow creating strategies if user sets their own userId
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      // Allow updating strategies if user owns them
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;
      
      // Allow deleting strategies if user owns them
      allow delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
  }
}



